## ðŸ§© STEP 11 â€” Workflow Orchestration (Temporal) + Human Approval + Safe Agent Execution

This step is where your platform becomes **enterprise / governmentâ€“grade**.

> **No agent or tool executes autonomously.**
> All actions flow through **deterministic workflows**, with **human authority** where required.

This step implements the **Hierarchical + Workflow Agents + Explicit Invocation (AgentTool)** philosophy you chose earlier.

---

## ðŸŽ¯ Purpose of Step 11

* Introduce **Temporal** as the *authoritative execution engine*
* Encode **business processes** as workflows (not LLM logic)
* Enable **Human-in-the-Loop approvals**
* Allow **AgentTools to run only inside workflow context**
* Ensure workflows are:

  * replayable
  * auditable
  * policy-enforced
  * safe under retries/failures

---

## ðŸ”’ Preconditions (Hard Gate)

You must already have:

* Step 10 MCP Gateway fully working
* Step 6 governedRoute middleware enforced
* Step 3 audit ledger working
* Step 4 policy-service enforced
* Temporal server + UI running (from Step 2)

If not â†’ **STOP**

---

## âœ… Deliverables at End of Step 11

* `workflow-service` using Temporal SDK (TypeScript)
* Canonical workflow patterns implemented
* Approval service + UI (minimal)
* Agent execution bound to workflow context
* Full audit trace across workflow â†’ agent â†’ tool â†’ approval

---

# ðŸ“ PROMPT PACK â€” STEP 11 (COPYâ€“PASTE INTO AGENTIC IDE)

---

## PROMPT 11.1 â€” Define Workflow Contracts & Context

```
Create shared workflow contracts.

Add schemas under /shared/schemas:

- WorkflowContext.json
- WorkflowStepResult.json
- ApprovalRequest.json
- ApprovalDecision.json

WorkflowContext must include:
- workflow_id
- tenant_id
- actor (initiator)
- purpose
- case_id (optional)
- current_step
- allowed_tools[]
- approval_required boolean

Rules:
- agent_invocation_id must always reference workflow_id
- no workflow step may execute without context

Output schema files only.
```

---

## PROMPT 11.2 â€” Implement workflow-service Skeleton (Temporal Worker)

```
Implement workflow-service in TypeScript using Temporal SDK.

Responsibilities:
- register workflows
- register activities
- start workflows on request

Expose API:
- POST /workflows/start
  - action: workflow.start (privileged=true)
- GET /workflows/{workflow_id}/status

Rules:
- governedRoute enforced
- write audit events:
  - WORKFLOW_STARTED
  - WORKFLOW_STEP
  - WORKFLOW_COMPLETED
  - WORKFLOW_FAILED

Output:
- workflow-service code
- Temporal worker setup
- Dockerfile
```

---

## PROMPT 11.3 â€” Implement a Canonical â€œSafe AI Workflowâ€

```
Implement a reference workflow:

Name: SafeAIAssistedWorkflow

Steps:
1) Intake
2) Retrieve Knowledge (call rag-service)
3) Draft Response (call llm-gateway)
4) Check Policy Obligations
5) If approval_required:
     - request human approval
     - wait for decision
6) If approved:
     - execute MCP tool (tool.invoke)
7) Notify + complete

Rules:
- Each step emits WORKFLOW_STEP audit event
- Retries must be idempotent
- No agent/tool invoked outside workflow context

Output:
- workflow definition
- activities implementations
- comments explaining each step
```

---

## PROMPT 11.4 â€” Bind Agent Execution to Workflow Context (Critical)

```
Implement AgentTool execution rules.

Requirements:
- agent.invoke is allowed ONLY when:
  - workflow_id is present
  - agent_invocation_id is generated by workflow
- agent cannot call mcp-gateway directly
- workflow-service must call mcp-gateway with:
  - workflow_id
  - agent_invocation_id
  - purpose
- policy-service must deny agent.invoke without workflow context

Output:
- enforcement code
- example authorize payloads
- documentation
```

---

## PROMPT 11.5 â€” Human Approval Service (Minimal but Real)

```
Implement approval-service (or module inside workflow-service).

Endpoints:
- POST /approvals/request
- POST /approvals/{approval_id}/decision
- GET /approvals/pending

Behavior:
- approvals persisted in Postgres
- decision types: approve | reject | request_more_info
- decision recorded immutably
- workflow waits on approval decision (Temporal signal)

Audit:
- APPROVAL_REQUESTED
- APPROVAL_DECISION

Output:
- approval tables + migration
- API code
- example curl flows
```

---

## PROMPT 11.6 â€” Approval UI (Minimal Internal Console)

```
Add a minimal approval UI (can be basic React).

Features:
- list pending approvals
- view context (summary only; no raw sensitive data)
- approve / reject with comment

Rules:
- must use governedRoute
- approval actions require purpose header
- decisions audited

Output:
- UI code
- screenshots or component tree
```

---

## PROMPT 11.7 â€” Failure, Retry & Idempotency Rules

```
Define and implement workflow safety rules.

Requirements:
- Temporal retries only on safe activities
- tool.invoke activities must be idempotent or guarded
- approval requests must not duplicate on retry
- workflow must survive worker restarts

Output:
- retry policy configuration
- code changes
- documentation
```

---

## PROMPT 11.8 â€” End-to-End Audit Trace Validation

```
Create a trace validation utility:

Given a workflow_id:
- retrieve all audit events
- verify ordering:
  WORKFLOW_STARTED â†’
  WORKFLOW_STEP â†’
  (AGENT_INVOKE â†’ TOOL_INVOKE â†’ APPROVAL if needed) â†’
  WORKFLOW_COMPLETED
- verify no tool invocation without workflow context

Output:
- validation script
- README
```

---

## PROMPT 11.9 â€” Tests (Non-negotiable)

```
Add tests covering:

1) workflow.start requires auth + audit
2) workflow executes without approval when not required
3) workflow pauses for approval when required
4) agent/tool invocation without workflow context is denied
5) workflow resumes correctly after approval
6) audit events cover full workflow trace

Output:
- test suite
- how to run
```

---

# âœ… Step 11 Acceptance Checklist

Proceed only if:

* [ ] Workflows run end-to-end in Temporal
* [ ] Agent actions only happen inside workflows
* [ ] Human approval pauses/resumes workflows correctly
* [ ] Tool invocation includes workflow_id + agent_invocation_id
* [ ] Policy denies agent/tool execution without workflow
* [ ] Audit trace can fully reconstruct workflow execution
* [ ] Temporal UI shows workflow state clearly

---

## ðŸ§  Lock This Mental Model

> **Workflows decide.
> Agents propose.
> Humans approve.
> Tools execute.
> Audit remembers everything.**

 